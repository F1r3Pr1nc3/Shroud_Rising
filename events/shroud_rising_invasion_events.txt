###############################################
# Shroud Rising Horrror Invasion Events
# Written by LastLeviathan
###############################################
namespace = shroud_rising_invasion
###############################################
# shroud_rising_invasion.0 | Incursions begin announce
# shroud_rising_invasion.1 | (Hidden) Spawn Timing Basic Rift
# 	shroud_rising_invasion.2 | (Hidden) Spawn selector Basic Rift - Check to ensure it doesn't spawn with an inhibitor
# shroud_rising_invasion.3 | (Hidden) Spawn Timing Greater Rift
# shroud_rising_invasion.2000 | (Hidden) Check to ensure it doesn't spawn with an inhibitor
# shroud_rising_invasion.4 | (Hidden) Spawn selector Greater Rift
# 	shroud_rising_invasion.50 | (Hidden) Selector for Greater Horror (Possibilities)
# shroud_rising_invasion.51 | (Hidden) Selector for Greater Horror Eye of Terror (Possibilities)
# shroud_rising_invasion.6 | (Hidden) Initial Spawn for Eye of Terror
# shroud_rising_invasion.7 | (Hidden) Spawn timing Eye of Terror
# shroud_rising_invasion.8 | (Hidden) Spawn selector Eye of Terror
# shroud_rising_invasion.9 | World Devoured by Horrors
# shroud_rising_invasion.10 | (Hidden) Chance of a Cultist Empire being neutral to spawned fleet
# shroud_rising_invasion.11 | (Hidden) Event for cultist planetfall if it reaches 100 devastation
# shroud_rising_invasion.12 | (Hidden) Add modifier for Cult Hub if they win
# shroud_rising_invasion.13 | Invasion Announce for owner
# shroud_rising_invasion.1301 | Invasion Message 1 from cult
# shroud_rising_invasion.1302 | Invasion Message 2 from cult
# shroud_rising_invasion.1303 | Invasion Message 3 from cult
# shroud_rising_invasion.1304 | (Hidden) Cleanup for if cultists are sitting around or done bombarding
# shroud_rising_invasion.1305 | (Hidden) Cleanup attempt 2 for if cultists are sitting around or done bombarding
# shroud_rising_invasion.2011 | Cultist Raid Incursion Announce Message
# shroud_rising_invasion.2012 | Small Crusade Incursion Announce Message
# shroud_rising_invasion.2021 | Shroud Entity Alert
# shroud_rising_invasion.2022 | Shroud Entity Powerful Alert
# shroud_rising_invasion.2031 | Greater Horror Alert Greater Rift
# shroud_rising_invasion.2032 | Greater Horror Alert EoT
# shroud_rising_invasion.2033 | Cosmic Horror Alert
# shroud_rising_invasion.100 | (Hidden) Shroud Ship Death Count
# shroud_rising_invasion.101 | (Hidden) Shroud Ship Victims
# shroud_rising_invasion.102 | (Hidden) Shroud Army Death Count
# shroud_rising_invasion.103 | (Hidden) Shroud Army Victims
# shroud_rising_invasion.105 | (Hidden) Trigger ancient god spawn
# shroud_rising_invasion.106 | Ancient God Announce
# shroud_rising_invasion.107 | (Hidden) Ancient God Defeated Effects
# shroud_rising_invasion.108 | Ancient God Defeated Announce
###############################################
###### THE INCURSIONS ####################
###############################################
# Shroud INVASION
# INCURSIONS BEGIN Announce (from 1st Rift, global event shroud_rising_shroud_rift.1)
country_event = {
	id = shroud_rising_invasion.0
	title = "shroud_rising_invasion.0.name"
	desc = "shroud_rising_invasion.0.desc"
	picture = GFX_evt_space_monster
	show_sound = event_the_great_awakening
	is_triggered_only = yes
	immediate = {
		# Enables the eye_of_terror_incursion_chain from shroud_rising_eye_of_terror.5
		if = {
			limit = { NOT = { has_global_flag = eot_incursions_start } }
			set_global_flag = eot_incursions_start
		}
	}
	option = { name = "apoc.100.a" custom_tooltip = "shroud_rising_invasion.0.b.tooltip" }
	option = { name = "BATTLESTATIONS" custom_tooltip = shroud_rising_invasion.0.b.tooltip }
}

###############################################
###### BASIC RIFTS SPAWN ####################
###############################################
# Spawn selector yearly for basic rift spawn (on_yearly_pulse)
event = {
	id = shroud_rising_invasion.1
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = rifts_basic_active
		NOT = { has_global_flag = eye_of_terror_sealed }
		OR = {
			exists = event_target:eye_of_terror_system
			any_system = { has_star_flag = shroud_invasion_system_basic }
		}
	}
	immediate = {
		if = {
			limit = { NOT = { exists = event_target:eye_of_terror_system } }
			random_system = {
				limit = {
					has_star_flag = shroud_invasion_system_basic
					NOT = { has_star_flag = rift_spawn_cooldown }
				}
				# set_timed_star_flag = { flag = rift_spawn_cooldown months = 3 } # Prevents spawning in the same system
				save_event_target_as = eye_of_terror_system
			}
		}
		if = {
			limit = { exists = event_target:eye_of_terror_system }
			event_target:eye_of_terror_system = {
				# Spawn up to 3 x enemies, triggers the spawn selector
				random_list = {
					# 2 months
					30 = { system_event = { id = shroud_rising_invasion.2 days = 60 random = 15 } }
					# 6 months
					30 = { system_event = { id = shroud_rising_invasion.2 days = 120 random = 15 } }
					# 2.3 years
					30 = { system_event = { id = shroud_rising_invasion.2 days = 180 random = 15 } }
					10 = { }
				}
				random_list = {
					# 6 months
					30 = { modifier = { factor = 0 NOT = { has_global_flag = rift_4_active } } system_event = { id = shroud_rising_invasion.2 days = 365 random = 15 } }
					# 1.3 years
					30 = { modifier = { factor = 0 NOT = { has_global_flag = rift_2_active } } system_event = { id = shroud_rising_invasion.2 days = 420 random = 15 } }
					# 2.3 years
					30 = { modifier = { factor = 0 NOT = { has_global_flag = rift_4_active } } system_event = { id = shroud_rising_invasion.2 days = 382 random = 15 } }
					10 = { }
				}
			}
		}
	}
}

# Spawn selector event for basic rifts
# eye_of_terror_system
# Check to see if the rift has been sealed before spawning
system_event = {
	id = shroud_rising_invasion.2
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = rifts_basic_active
		has_star_flag = shroud_invasion_system_basic
		NOR = {
			has_global_flag = eye_of_terror_sealed # Check to see if rift has been sealed before spawning
			any_system_megastructure = { is_megastructure_type = rift_inhibitor_2 }
		}
	}
	immediate = {
		random_list = {
			###############################################
			######## 1 x Corrupt Avatar (~5-10k) ##########
			###############################################
			30 = {
				if = {
					limit = { NOT = { exists = event_target:shroud_storm_horror } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_entities
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_storm_horror } # save_event_target_as = shroud_entity_fleet }
					}
				}
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2021 }					# Incursion Alert
				}
				create_fleet = {
					# name = random
					settings = { spawn_debris = no is_boss = yes }
					effect = {
						set_owner = event_target:shroud_storm_horror
						create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
						set_location = root
						set_fleet_stance = aggressive
						set_fleet_bombardment_stance = devour
						set_aggro_range_measure_from = self
						set_aggro_range = 500
					}
				}
			}
			#################################################
			########  3 x Corrupt Avatar (10k ea) ###########
			#################################################
			15 = {
				modifier = { factor = 0 mid_game_years_passed < 30 }
				if = {
					limit = { NOT = { exists = event_target:shroud_storm_horror } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_entities
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_storm_horror } # save_event_target_as = shroud_entity_fleet }
					}
				}
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2021 }					# Incursion Alert
				}
				event_target:shroud_storm_horror = {
					while = { count = 3
						create_fleet = {
							# name = random
							settings = { spawn_debris = no is_boss = yes }
							effect = {
								set_owner = event_target:shroud_storm_horror
								create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
								set_location = root
								set_fleet_stance = aggressive
								set_fleet_bombardment_stance = devour
								set_aggro_range_measure_from = self
								set_aggro_range = 500
							}
						}
					}
				}
			}
			##########################################################################
			########  3 x Corrupt Avatar (10k ea) + 1 x Entity (~20k ea)  ############
			##########################################################################
			5 = {
				modifier = { factor = 0 NOT = { has_global_flag = eye_of_terror_open } }
				if = {
					limit = { NOT = { exists = event_target:shroud_storm_horror } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_entities
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_storm_horror } # save_event_target_as = shroud_entity_fleet }
					}
				}
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2021 }					# Incursion Alert
				}
				event_target:shroud_storm_horror = {
					while = { count = 3
						create_fleet = {
							# name = random
							settings = { spawn_debris = no is_boss = yes }
							effect = {
								set_owner = event_target:shroud_storm_horror
								create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
								set_location = root
								set_fleet_stance = aggressive
								set_fleet_bombardment_stance = devour
								set_aggro_range_measure_from = self
								set_aggro_range = 500
							}
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_shroud_entity" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
				}
			}
			###############################################
			########  Tiny Cultist Fleet (5k) #############
			###############################################
			40 = {
				random_galaxy_species = {
					limit = { is_crossbreeding_possible = yes NOT = { has_trait = trait_adeptus_custodes } }
					create_species = {
						name = "NAME_shroud_cultists"
						class = this # random_non_machine
						name_list = "CULTISTS"
						portrait = this # random
						traits = random
						effect = {
							random = { chance = 50 change_species_characteristics = { add_trait = trait_latent_psionic } }
							save_event_target_as = cultist_raid_fleet_species
						}
					}
				}
				if = {
					limit = { NOT = { exists = event_target:cultist_raid_fleet } }
					create_country = {
						name = "NAME_shroud_cultist_country"
						type = shroud_cult
						species = event_target:cultist_raid_fleet_species
						name_list = "CULTISTS"
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = cultist_raid_fleet }
					}
				}

				event_target:cultist_raid_fleet = {
					change_dominant_species = { species = event_target:cultist_raid_fleet_species }
					create_leader = {
						class = commander
						species = event_target:cultist_raid_fleet_species
						name = random
						skill = 3
						leader_age_min = 25
						leader_age_max = 45
						traits = { trait = subclass_commander_admiral trait = leader_trait_psionic }
					}
					create_fleet = {
						effect = {
							while = { count = 1
								create_ship = { name = random design = "NAME_Lancer" graphical_culture = "pirate_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Outrider" graphical_culture = "pirate_01" }
							}
							# corvette
							while = { count = 2
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "mammalian_01" }
							}
							# corvette
							while = { count = 2
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "humanoid_01" }
							}
							# corvette
							while = { count = 3
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "plantoid_01" }
							}
							# destroyer
							while = { count = 2
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "reptilian_01" }
							}
							# cruiser
							while = { count = 1
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "reptilian_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Void_Champion" prefix = no graphical_culture = "pirate_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Reaver" graphical_culture = "pirate_01" }
							}
							set_fleet_flag = cultist_fleet
							set_owner = prev
							set_location = root
							set_fleet_stance = aggressive
							set_aggro_range = 150
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = indiscriminate
							closest_system = {
								limit = {
									any_system_colony = {
										NOR = { has_planet_flag = cultist_raid_target has_modifier = recent_cult_invasion }
										num_sapient_pops > 0
									}
								}
								random_system_colony = {
									limit = { num_sapient_pops > 0 }
									set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
									save_event_target_as = cultist_planet
								}
								prev = {
									auto_move_to_planet = { target = event_target:cultist_planet clear_auto_move_on_arrival = no }
								}
							}
							assign_leader = last_created_leader
						}
					}
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2011 }					# Incursion Alert
					}
				}
			}
			################################################
			########  Small Cultist Fleet (10k) ############
			################################################
			15 = {
				modifier = { factor = 0 mid_game_years_passed < 30 }
				modifier = { factor = 2 mid_game_years_passed > 45 }
				random_galaxy_species = {
					limit = { is_crossbreeding_possible = yes NOT = { has_trait = trait_adeptus_custodes } }
					create_species = {
						name = "NAME_shroud_cultists"
						class = this # random_non_machine
						name_list = "CULTISTS"
						portrait = this # random
						traits = random
						effect = {
							random = { chance = 50 change_species_characteristics = { add_trait = trait_latent_psionic } }
							save_event_target_as = cultist_raid_fleet_species
						}
					}
				}
				if = {
					limit = { NOT = { exists = event_target:cultist_raid_fleet } }
					create_country = {
						name = "NAME_shroud_cultist_country"
						type = shroud_cult
						species = event_target:cultist_raid_fleet_species
						name_list = "CULTISTS"
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = cultist_raid_fleet }
					}
				}

				event_target:cultist_raid_fleet = {
					change_dominant_species = { species = event_target:cultist_raid_fleet_species }
					create_fleet = {
						settings = { spawn_debris = yes }
						effect = {
							while = { count = 1
								create_ship = { name = random design = "NAME_Void_Champion" prefix = no graphical_culture = "pirate_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Lancer" graphical_culture = "pirate_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Outrider" graphical_culture = "pirate_01" }
							}
							# corvette
							while = { count = 3
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "mammalian_01" }
							}
							# corvette
							while = { count = 5
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "humanoid_01" }
							}
							# corvette
							while = { count = 6
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "plantoid_01" }
							}
							# destroyer
							while = { count = 2
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "reptilian_01" }
							}
							# cruiser
							while = { count = 1
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "reptilian_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Reaver" graphical_culture = "pirate_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Avatar" graphical_culture = "fallen_empire_04" }
							}
							set_fleet_flag = cultist_fleet
							set_owner = prev
							set_location = root
							set_fleet_stance = aggressive
							set_aggro_range = 150
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = indiscriminate
							closest_system = {
								limit = {
									any_system_colony = {
										NOR = { has_planet_flag = cultist_raid_target has_modifier = recent_cult_invasion }
										num_sapient_pops > 0
									}
								}
								random_system_colony = {
									limit = { num_sapient_pops > 0 }
									set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
									save_event_target_as = cultist_planet
								}
								prev = {
									auto_move_to_planet = { target = event_target:cultist_planet clear_auto_move_on_arrival = no }
								}
							}
						}
					}
					create_leader = {
						class = commander
						species = event_target:cultist_raid_fleet_species
						name = random
						skill = 3
						leader_age_min = 25
						leader_age_max = 45
						traits = { trait = subclass_commander_admiral trait = leader_trait_psionic }
					}
					last_created_fleet = {
						if = {
							limit = {
								has_fleet_flag = cultist_fleet
								NOT = { exists = leader }
							}
							assign_leader = last_created_leader
						}
					}
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2011 }					# Incursion Alert
					}
				}
			}
			###############################################
			########  Big Cultist Fleet (25k) #############
			###############################################
			10 = {
				modifier = { factor = 0 mid_game_years_passed < 75 }
				random_galaxy_species = {
					limit = { is_crossbreeding_possible = yes NOT = { has_trait = trait_adeptus_custodes } }
					create_species = {
						name = "NAME_shroud_cultists"
						class = this # random_non_machine
						name_list = "CULTISTS"
						portrait = this # random
						traits = random
						effect = {
							random = { chance = 50 change_species_characteristics = { add_trait = trait_latent_psionic } }
							save_event_target_as = cultist_raid_fleet_species
						}
					}
				}
				if = {
					limit = { NOT = { exists = event_target:cultist_raid_fleet } }
					create_country = {
						name = "NAME_shroud_cultist_country"
						type = shroud_cult
						species = event_target:cultist_raid_fleet_species
						name_list = "CULTISTS"
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = cultist_raid_fleet }
					}
				}

				event_target:cultist_raid_fleet = {
					change_dominant_species = { species = event_target:cultist_raid_fleet_species }
					create_leader = {
						class = commander
						species = event_target:cultist_raid_fleet_species
						name = random
						skill = 3
						leader_age_min = 25
						leader_age_max = 45
						traits = { trait = subclass_commander_admiral trait = leader_trait_psionic }
					}
					country_event = { id = shroud_rising_invasion.10 }	# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2011 }					# Incursion Alert
					}
					create_fleet = {
						settings = { spawn_debris = yes }
						effect = {
							while = { count = 1
								create_ship = { name = random design = "NAME_Ancestral_Glory" graphical_culture = "pirate_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Lancer" graphical_culture = "pirate_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Outrider" graphical_culture = "pirate_01" }
							}
							# corvette
							while = { count = 3
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "mammalian_01" }
							}
							# corvette
							while = { count = 5
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "humanoid_01" }
							}
							# corvette
							while = { count = 6
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "plantoid_01" }
							}
							# destroyer
							while = { count = 1
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "reptilian_01" }
							}
							# destroyer
							while = { count = 1
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "avian_01" }
							}
							# cruiser
							while = { count = 3
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "reptilian_01" }
							}
							# cruiser
							while = { count = 1
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "humanoid_01" }
							}
							# cruiser
							while = { count = 2
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "mammalian_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Reaver" graphical_culture = "pirate_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Avatar" graphical_culture = "fallen_empire_04" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Zealot" graphical_culture = "fallen_empire_02" }
							}
							set_fleet_flag = cultist_fleet
							set_owner = prev
							set_location = root
							set_fleet_stance = aggressive
							set_aggro_range = 150
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = indiscriminate
							closest_system = {
								limit = {
									any_system_colony = {
										NOR = { has_planet_flag = cultist_raid_target has_modifier = recent_cult_invasion }
										num_sapient_pops > 0
									}
								}
								random_system_colony = {
									limit = { num_sapient_pops > 0 }
									set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
									save_event_target_as = cultist_planet
								}
								prev = {
									auto_move_to_planet = { target = event_target:cultist_planet clear_auto_move_on_arrival = no }
								}
							}
						}
					}
					last_created_fleet = {
						if = {
							limit = {
								has_fleet_flag = cultist_fleet
								NOT = { exists = leader }
							}
							assign_leader = last_created_leader
						}
					}
				}
			}
		}
		set_timed_star_flag = { flag = rift_spawn_cooldown months = 2 }		# Prevents spawning in the same system
	}
}

###############################################
###### Greater RIFTS SPAWN ####################
###############################################
# Spawn timing yearly for greater rift spawn (on_yearly_pulse)
event = {
	id = shroud_rising_invasion.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eye_of_terror_open
		has_global_flag = rifts_basic_active		# Set on v.3.9.3
		OR = { has_global_flag = rift_2_active has_global_flag = rift_4_active }
		NOR = { has_global_flag = greater_rift_timer has_global_flag = eye_of_terror_sealed }
		OR = {
			exists = event_target:shroud_rift_system_2
			exists = event_target:shroud_rift_system_4
			any_system = { has_star_flag = shroud_invasion_system_greater }
		}
	}
	immediate = {
		set_timed_global_flag = { flag = greater_rift_timer years = 3 }		# Ensures it only triggers every 3 years
		event_target:global_event_country = {
			random_list = { # Spawn up to 3 x enemies, triggers the spawn selector
				33 = { country_event = { id = shroud_rising_invasion.2000 days = 30 random = 30 } }		# 2 years # 720
				33 = { country_event = { id = shroud_rising_invasion.2000 days = 60 random = 30 } }		# 3 years # 1095
				33 = { country_event = { id = shroud_rising_invasion.2000 days = 120 random = 30 } }	# 4 years # 1460
			}
		}
	}
}

# Check to see if the rift has been sealed before spawning
country_event = {
	id = shroud_rising_invasion.2000
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eye_of_terror_open
		has_global_flag = rifts_basic_active
		OR = { has_global_flag = rift_2_active has_global_flag = rift_4_active }
	}
	immediate = {
		random_list = {
			33 = { modifier = { factor = 0 OR = { NOT = { exists = event_target:shroud_rift_system_2 } event_target:shroud_rift_system_2 = { any_system_megastructure = { is_megastructure_type = rift_inhibitor_2 } } } } event_target:shroud_rift_system_2 = { system_event = { id = shroud_rising_invasion.4 } } }
			33 = { modifier = { factor = 0 OR = { NOT = { exists = event_target:shroud_rift_system_4 } event_target:shroud_rift_system_4 = { any_system_megastructure = { is_megastructure_type = rift_inhibitor_2 } } } } event_target:shroud_rift_system_4 = { system_event = { id = shroud_rising_invasion.4 } } }
			33 = { random_system = { limit = { has_star_flag = shroud_invasion_system_greater NOT = { any_system_megastructure = { is_megastructure_type = rift_inhibitor_2 } } } system_event = { id = shroud_rising_invasion.4 } } }
		}
	}
}

# eye_of_terror_system
# Spawn selector event for greater rifts (indirect on 3 years pulse)
system_event = {
	id = shroud_rising_invasion.4
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = eye_of_terror_sealed }
		# NOT = { any_system_megastructure = { is_megastructure_type = rift_inhibitor_2 } }
	}
	immediate = {
		random_list = {
			###############################################
			######## 2 x Corrupt Avatar (~5-10k ea) ##########
			###############################################
			30 = {
				modifier = { factor = 0 OR = { mid_game_years_passed < 45 end_game_years_passed > 75 } }
				if = {
					limit = { NOT = { exists = event_target:shroud_storm_horror } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_entities
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_storm_horror } # save_event_target_as = shroud_entity_fleet }
					}
				}
				event_target:shroud_storm_horror = {
					country_event = { id = shroud_rising_invasion.10 }	# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2021 }					# Incursion Alert
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
				}
			}
			#######################################################################
			########  3 x Corrupt Avatar (10k ea) + 1 x Entity (20k ea) ###########
			#######################################################################
			10 = {
				modifier = { factor = 0 OR = { mid_game_years_passed < 45 end_game_years_passed > 50 } }
				if = {
					limit = { NOT = { exists = event_target:shroud_storm_horror } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_entities
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_storm_horror } # save_event_target_as = shroud_entity_fleet }
					}
				}

				event_target:shroud_storm_horror = {
					country_event = { id = shroud_rising_invasion.10 }	# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2021 }					# Incursion Alert
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_Corrupted_Avatar" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_shroud_entity" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
				}
			}
			#############################################
			########  4  x Entity (~20k ea)  ############
			#############################################
			5 = {
				modifier = { factor = 0 NAND = { has_global_flag = eye_of_terror_open mid_game_years_passed < 75 } }
				if = {
					limit = { NOT = { exists = event_target:shroud_storm_horror } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_entities
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_storm_horror } # save_event_target_as = shroud_entity_fleet }
					}
				}
				event_target:shroud_storm_horror = {
					country_event = { id = shroud_rising_invasion.10 }	# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2021 }					# Incursion Alert
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_shroud_entity" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_shroud_entity" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_shroud_entity" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = event_target:shroud_storm_horror
							create_ship = { name = "NAME_ancient_god" design = "NAME_shroud_entity" }
							set_location = root
							set_fleet_stance = aggressive
							set_fleet_bombardment_stance = devour
							set_aggro_range_measure_from = self
							set_aggro_range = 500
						}
					}
				}
			}
			###############################################
			########  Large Cultist Fleet (25k) #############
			###############################################
			40 = {
				modifier = { factor = 0 mid_game_years_passed < 45 }
				random_galaxy_species = {
					limit = { is_crossbreeding_possible = yes NOT = { has_trait = trait_adeptus_custodes } }
					create_species = {
						name = "NAME_shroud_cultists"
						class = this # random_non_machine
						name_list = "CULTISTS"
						portrait = this # random
						traits = random
						effect = {
							random = { chance = 50 change_species_characteristics = { add_trait = trait_latent_psionic } }
							save_event_target_as = cultist_raid_fleet_species
						}
					}
				}
				if = {
					limit = { NOT = { exists = event_target:cultist_raid_fleet } }
					create_country = {
						name = "NAME_shroud_cultist_country"
						type = shroud_cult
						species = event_target:cultist_raid_fleet_species
						name_list = "CULTISTS"
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = cultist_raid_fleet }
					}
				}
				event_target:cultist_raid_fleet = {
					change_dominant_species = { species = event_target:cultist_raid_fleet_species }
					create_leader = {
						class = commander
						species = event_target:cultist_raid_fleet_species
						name = random
						skill = 3
						leader_age_min = 25
						leader_age_max = 45
						traits = { trait = subclass_commander_admiral trait = leader_trait_psionic }
					}
					country_event = { id = shroud_rising_invasion.10 }	# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2011 }					# Incursion Alert
					}
					create_fleet = {
						settings = { spawn_debris = yes }
						effect = {
							while = { count = 1
								create_ship = { name = random design = "NAME_Ancestral_Glory" graphical_culture = "pirate_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Lancer" graphical_culture = "pirate_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Outrider" graphical_culture = "pirate_01" }
							}
							# corvette
							while = { count = 3
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "mammalian_01" }
							}
							# corvette
							while = { count = 5
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "humanoid_01" }
							}
							# corvette
							while = { count = 6
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "plantoid_01" }
							}
							# destroyer
							while = { count = 1
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "reptilian_01" }
							}
							# destroyer
							while = { count = 1
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "avian_01" }
							}
							# cruiser
							while = { count = 3
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "reptilian_01" }
							}
							# cruiser
							while = { count = 1
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "humanoid_01" }
							}
							# cruiser
							while = { count = 2
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "mammalian_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Reaver" graphical_culture = "pirate_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Avatar" graphical_culture = "fallen_empire_04" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Zealot" graphical_culture = "fallen_empire_02" }
							}
							set_fleet_flag = cultist_fleet
							set_owner = prev
							set_location = root
							set_fleet_stance = aggressive
							set_aggro_range = 150
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = indiscriminate
							closest_system = {
								limit = {
									any_system_colony = {
										num_sapient_pops > 0
										NOR = { has_planet_flag = cultist_raid_target has_modifier = recent_cult_invasion }
									}
								}
								random_system_colony = {
									limit = { num_sapient_pops > 0 }
									set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
									save_event_target_as = cultist_planet
								}
								prev = {
									auto_move_to_planet = { target = event_target:cultist_planet clear_auto_move_on_arrival = no }
								}
							}
						}
					}
					last_created_fleet = {
						if = {
							limit = {
								has_fleet_flag = cultist_fleet
								NOT = { exists = leader }
							}
							assign_leader = last_created_leader
						}
					}
				}
			}
			################################################
			########  Cultist Crusade (50k) ############
			################################################
			15 = {
				modifier = { factor = 0 mid_game_years_passed < 65 }
				random_galaxy_species = {
					limit = { is_crossbreeding_possible = yes NOT = { has_trait = trait_adeptus_custodes } }
					create_species = {
						name = "NAME_shroud_cultists"
						class = this # random_non_machine
						name_list = "CULTISTS"
						portrait = this # random
						traits = random
						effect = {
							random = { chance = 50 change_species_characteristics = { add_trait = trait_latent_psionic } }
							save_event_target_as = cultist_raid_fleet_species
						}
					}
				}
				if = {
					limit = { NOT = { exists = event_target:cultist_raid_fleet } }
					create_country = {
						name = "NAME_shroud_cultist_country"
						type = shroud_cult
						species = event_target:cultist_raid_fleet_species
						name_list = "CULTISTS"
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = cultist_raid_fleet }
					}
				}
				event_target:cultist_raid_fleet = {
					change_dominant_species = { species = event_target:cultist_raid_fleet_species }
					create_fleet = {
						settings = { spawn_debris = yes }
						effect = {
							while = { count = 2
								create_ship = { name = random design = "NAME_Ancestral_Glory" graphical_culture = "pirate_01" }
							}
							while = { count = 8
								create_ship = { name = random design = "NAME_Void_Champion" graphical_culture = "pirate_01" }
							}
							while = { count = 12
								create_ship = { name = random design = "NAME_Lancer" graphical_culture = "pirate_01" }
							}
							while = { count = 20
								create_ship = { name = random design = "NAME_Outrider" graphical_culture = "pirate_01" }
							}
							while = { count = 3
								create_ship = { name = random design = "NAME_Spearhead" graphical_culture = "mammalian_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Spearhead" graphical_culture = "arthropoid_01" }
							}
							while = { count = 3
								create_ship = { name = random design = "NAME_Deaths_Head" graphical_culture = "molluscoid_01" }
							}
							while = { count = 5
								create_ship = { name = random design = "NAME_Deaths_Head" graphical_culture = "humanoid_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Bug_Crusher" graphical_culture = "molluscoid_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Avatar" graphical_culture = "fallen_empire_04" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Zealot" graphical_culture = "fallen_empire_02" }
							}
							set_fleet_flag = cultist_fleet
							set_owner = prev
							set_location = root
							set_fleet_stance = aggressive
							set_aggro_range = 150
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = indiscriminate
							closest_system = {
								limit = {
									any_system_colony = {
										NOR = { has_planet_flag = cultist_raid_target has_modifier = recent_cult_invasion }
										num_pops > 20
									}
								}
								random_system_colony = {
									limit = { num_pops > 20 }
									set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
									save_event_target_as = cultist_planet
								}
								prev = {
									auto_move_to_planet = { target = event_target:cultist_planet clear_auto_move_on_arrival = no }
								}
							}
						}
					}
					create_leader = {
						class = commander
						species = event_target:cultist_raid_fleet_species
						name = random
						skill = 3
						leader_age_min = 25
						leader_age_max = 45
						traits = { trait = subclass_commander_admiral trait = leader_trait_psionic }
					}
					last_created_fleet = {
						if = {
							limit = {
								has_fleet_flag = cultist_fleet
								NOT = { exists = leader }
							}
							assign_leader = last_created_leader
						}
					}
					country_event = { id = shroud_rising_invasion.10 }	# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
					every_playable_country = {
						limit = { is_ai = no has_policy_flag = incursion_alert_all }
						country_event = { id = shroud_rising_invasion.2011 }					# Incursion Alert
					}
				}
			}
			###############################################
			########  Avatar (50k) #############
			###############################################
			25 = {
				modifier = { factor = 0 mid_game_years_passed < 25 }
				modifier = { factor = 10 mid_game_years_passed > 50 }
				if = {
					limit = { NOT = { exists = event_target:shroud_horror_fleet } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_horrors
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_horror_fleet }
					}
				}
				set_timed_star_flag = { flag = rift_spawn_cooldown months = 2 }				# Prevents spawning in the same system
				system_event = { id = shroud_rising_invasion.50 }				# 180 choose a Greater Shroud Horror to spawn
			}
		}
	}
}

# Selector to Spawn Shroud Horror (indirect on_yearly_pulse)
system_event = {
	id = shroud_rising_invasion.50
	hide_window = yes
	is_triggered_only = yes
	# fire_only_once = yes
	immediate = {
		random_list = {
			# Chance of Different Avatars
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror" design = "NAME_greater_horror" }
						}
					}
				}
			}
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_desire" design = "NAME_horror_desire" }
						}
					}
				}
			}
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_hunger" design = "NAME_horror_hunger" }
						}
					}
				}
			}
			# Chance of stronger entities
			20 = {
				every_playable_country = {
					limit = {
						is_ai = no
						OR = { has_policy_flag = incursion_alert_all has_policy_flag = incursion_alert_major }
					}
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_whisper" design = "NAME_horror_whisper" }
						}
					}
				}
			}
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_corruption" design = "NAME_horror_corruption" }
						}
					}
				}
			}
		}
		last_created_fleet = {
			set_location = root
			set_fleet_stance = aggressive
			set_fleet_bombardment_stance = devour
			set_aggro_range_measure_from = self
			set_aggro_range = 300
		}
	}
}

# Selector to Spawn Shroud Horror for Eye of Terror
system_event = {
	id = shroud_rising_invasion.51
	hide_window = yes
	is_triggered_only = yes
	# fire_only_once = yes
	immediate = {
		random_list = {
			# Chance of Different Avatars
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror" design = "NAME_greater_horror" }
						}
					}
				}
			}
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_desire" design = "NAME_horror_desire" }
						}
					}
				}
			}
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_hunger" design = "NAME_horror_hunger" }
						}
					}
				}
			}
			# Chance of stronger entities
			20 = {
				every_playable_country = {
					limit = {
						is_ai = no
						OR = { has_policy_flag = incursion_alert_all has_policy_flag = incursion_alert_major }
					}
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_whisper" design = "NAME_horror_whisper" }
						}
					}
				}
			}
			20 = {
				every_playable_country = {
					limit = { is_ai = no has_policy_flag = incursion_alert_all }
					country_event = { id = shroud_rising_invasion.2032 }					# Incursion Alert
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_greater_horror_corruption" design = "NAME_horror_corruption" }
						}
					}
				}
			}
		}
		last_created_fleet = {
			set_location = root
			set_fleet_stance = aggressive
			set_fleet_bombardment_stance = devour
			set_aggro_range_measure_from = self
			set_aggro_range = 300
		}
	}
}

###############################################
###### Eye of Terror SPAWN ####################
###############################################
##### INITIAL Eye of Terror SPAWN ############################
# From shroud_rising_eye_of_terror.3 (only_once)
system_event = {
	id = shroud_rising_invasion.6
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	immediate = {
		if = {
			limit = { NOT = { exists = event_target:shroud_horror_country } }
			create_species = {
				name = "NAME_shroud_horrors"
				class = random_non_machine
				portrait = random
				traits = random
				effect = {
					change_species_characteristics = { add_trait = trait_latent_psionic }
				}
			}
			create_country = {
				name = "NAME_shroud_horrors"
				type = shroud_horrors
				species = last_created_species
				name_list = "SHROUD_HORRORS"
				flag = {
					icon = { category = "special" file = "the_shroud.dds" }
					background = { category = "backgrounds" file = "00_solid.dds" }
					colors = { "dark_purple" "black" "null" "null" }
				}
				effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_horror_country }
			}
		}
		create_fleet = {
			# name = random
			settings = { spawn_debris = no is_boss = yes }
			effect = {
				set_owner = event_target:shroud_horror_country
				create_ship = { name = "NAME_greater_horror_hunger" design = "NAME_greater_horror" }
				set_location = root
				set_fleet_stance = aggressive
				set_fleet_bombardment_stance = devour
				set_aggro_range_measure_from = self
				set_aggro_range = 300
			}
		}
		create_fleet = {
			# name = random
			settings = { spawn_debris = no is_boss = yes }
			effect = {
				set_owner = event_target:shroud_horror_country
				create_ship = { name = "NAME_greater_horror_desire" design = "NAME_horror_desire" }
				set_location = root
				set_fleet_stance = aggressive
				set_fleet_bombardment_stance = devour
				set_aggro_range_measure_from = self
				set_aggro_range = 300
			}
		}
		# last_created_fleet = { fleet_event = { id = shroud_rising_invasion } }
	}
}

# Spawn timing selector yearly for Eye of Terror (on_decade_pulse)
event = {
	id = shroud_rising_invasion.7
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eye_of_terror_open
		NOT = { has_global_flag = eye_of_terror_sealed }
	}
	immediate = {
		if = {
			limit = { NOT = { exists = event_target:eye_of_terror_system } }
			random_system = {
				limit = {
					has_star_flag = eye_of_terror_system					# shroud_invasion_system_greater
					# NOT = { has_star_flag = rift_spawn_cooldown }
				}
				save_global_event_target_as = eye_of_terror_system
			}
		}
		event_target:eye_of_terror_system = {
			# Spawn 1 x enemies, triggers the spawn selector
			random_list = {
				33 = { system_event = { id = shroud_rising_invasion.8 days = 30 random = 15 } }
				33 = { system_event = { id = shroud_rising_invasion.8 days = 90 random = 18 } }
				33 = { system_event = { id = shroud_rising_invasion.8 days = 180 random = 23 } }
			}
		}
	}
}

# Spawn selector event for Eye of Terror (indirect on_decade_pulse)
system_event = {
	id = shroud_rising_invasion.8
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = eye_of_terror_sealed }
	}
	immediate = {
		random_list = {
			###############################################
			########  Cultist Crusade (90k) #############
			###############################################
			25 = {
				#40
				random_galaxy_species = {
					limit = { is_crossbreeding_possible = yes NOT = { has_trait = trait_adeptus_custodes } }
					create_species = {
						name = "NAME_shroud_cultists"
						class = this # random_non_machine
						name_list = "CULTISTS"
						portrait = this # random
						traits = random
						effect = {
							random = { chance = 50 change_species_characteristics = { add_trait = trait_latent_psionic } }
							save_event_target_as = cultist_raid_fleet_species
						}
					}
				}
				if = {
					limit = { NOT = { exists = event_target:cultist_raid_fleet } }
					create_country = {
						name = "NAME_shroud_cultist_country"
						type = shroud_cult
						species = event_target:cultist_raid_fleet_species
						name_list = "CULTISTS"
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = cultist_raid_fleet }
					}
				}

				event_target:cultist_raid_fleet = {
					change_dominant_species = { species = event_target:cultist_raid_fleet_species }
					create_leader = {
						class = commander
						species = event_target:cultist_raid_fleet_species
						name = random
						skill = 5
						leader_age_min = 25
						leader_age_max = 45
						traits = { trait = subclass_commander_admiral trait = leader_trait_psionic }
					}
					country_event = { id = shroud_rising_invasion.10 }	# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
					every_playable_country = {
						limit = {
							is_ai = no
							OR = { has_policy_flag = incursion_alert_all has_policy_flag = incursion_alert_major }
						}
						country_event = { id = shroud_rising_invasion.2012 }					# Incursion Alert
					}
					create_fleet = {
						settings = { spawn_debris = yes }
						effect = {
							while = { count = 1
								create_ship = { name = random design = "NAME_Eternal" graphical_culture = "fallen_empire_04" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Ancestral_Glory" graphical_culture = "pirate_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Void_Champion" graphical_culture = "pirate_01" }
							}
							while = { count = 12
								create_ship = { name = random design = "NAME_Lancer" graphical_culture = "pirate_01" }
							}
							while = { count = 24
								create_ship = { name = random design = "NAME_Outrider" graphical_culture = "pirate_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Spearhead" graphical_culture = "mammalian_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Spearhead" graphical_culture = "arthropoid_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Spearhead" graphical_culture = "necroid_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Spearhead" graphical_culture = "arthropoid_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Deaths_Head" graphical_culture = "molluscoid_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Deaths_Head" graphical_culture = "humanoid_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Deaths_Head" graphical_culture = "plantoid_01" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Deaths_Head" graphical_culture = "avian_01" }
							}
							while = { count = 4
								create_ship = { name = random design = "NAME_Bug_Crusher" graphical_culture = "molluscoid_01" }
							}
							while = { count = 2
								create_ship = { name = random design = "NAME_Avatar" graphical_culture = "fallen_empire_04" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Avatar" graphical_culture = "fallen_empire_01" }
							}
							while = { count = 3
								create_ship = { name = random design = "NAME_Zealot" graphical_culture = "fallen_empire_02" }
							}
							while = { count = 1
								create_ship = { name = random design = "NAME_Zealot" graphical_culture = "fallen_empire_03" }
							}
							# corvette
							while = { count = 3
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "mammalian_01" }
							}
							# corvette
							while = { count = 5
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "humanoid_01" }
							}
							# corvette
							while = { count = 5
								create_ship = { name = random design = "NAME_Dagger" graphical_culture = "plantoid_01" }
							}
							# destroyer
							while = { count = 1
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "reptilian_01" }
							}
							# destroyer
							while = { count = 1
								create_ship = { name = random design = "NAME_Ravager" graphical_culture = "avian_01" }
							}
							# cruiser
							while = { count = 2
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "reptilian_01" }
							}
							# cruiser
							while = { count = 1
								create_ship = { name = random design = "NAME_Derelict" graphical_culture = "humanoid_01" }
							}
							set_fleet_flag = cultist_fleet
							set_owner = prev
							set_location = root # event_target:eye_of_terror_system
							set_fleet_stance = aggressive
							set_aggro_range = 150
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = indiscriminate
							assign_leader = last_created_leader
						}
					}
					last_created_fleet = {
						closest_system = {
							limit = {
								any_system_colony = {
									NOR = { has_planet_flag = cultist_raid_target has_modifier = recent_cult_invasion }
									num_pops > 25
								}
							}
							random_system_colony = {
								limit = { num_pops > 25 }
								set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
								save_event_target_as = cultist_planet
							}
							prev = {
								auto_move_to_planet = { target = event_target:cultist_planet clear_auto_move_on_arrival = no }
							}
						}
					}
				}
			}
			###############################################
			########  Avatar (50k) #############
			###############################################
			65 = {
				if = {
					limit = { NOT = { exists = event_target:shroud_horror_fleet } }
					create_country = {
						name = "NAME_shroud_horrors"
						type = shroud_horrors
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_horror_fleet }
					}
				}
				# Event to gauge neutrality toward shrouded country, with selector for cult countries' neutrality.
				event_target:shroud_horror_fleet = { country_event = { id = shroud_rising_invasion.10 } }
				system_event = { id = shroud_rising_invasion.51 }				# 180 choose a Greater Shroud Horror to spawn
			}
			###############################################
			########  Cosmic Horror (150-200k) #############
			###############################################
			5 = {
				modifier = { factor = 0 mid_game_years_passed < 75 }
				modifier = { factor = 3 end_game_years_passed > 2 }
				modifier = { factor = 10 end_game_years_passed > 28 }
				if = {
					limit = { NOT = { exists = event_target:shroud_horror_fleet } }
					create_country = {
						name = "NAME_cosmic_horror"
						type = shroud_horrors
						name_list = "SHROUD_HORRORS"
						flag = {
							icon = { category = "special" file = "the_shroud.dds" }
							background = { category = "backgrounds" file = "00_solid.dds" }
							colors = { "dark_purple" "black" "null" "null" }
						}
						effect = { apply_shroud_rising_difficulty = yes save_global_event_target_as = shroud_horror_fleet }
					}
				}
				every_playable_country = {
					limit = {
						is_ai = no
						OR = { has_policy_flag = incursion_alert_all has_policy_flag = incursion_alert_major has_policy_flag = incursion_alert_none }
					}
					country_event = { id = shroud_rising_invasion.2033 }					# Incursion Alert	Cosmic horror
				}
				event_target:shroud_horror_fleet = {
					create_fleet = {
						# name = random
						settings = { spawn_debris = no is_boss = yes }
						effect = {
							set_owner = prev
							create_ship = { name = "NAME_cosmic_horror" design = "NAME_cosmic_horror" }
							set_location = root # event_target:eye_of_terror_system
							set_fleet_stance = aggressive
							set_aggro_range = 300
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = devour
						}
					}
				}
			}
			###############################################
			########  Ancient God (k) #############
			###############################################
			1 = {
				modifier = { factor = 0 end_game_years_passed < 15
					OR = { has_global_flag = ancient_god_active has_global_flag = ancient_god_defeated }
				}
				modifier = { factor = 2 end_game_years_passed > 25 }
				modifier = { factor = 5 end_game_years_passed > 50 }
				system_event = { id = shroud_rising_invasion.105 }
			}
		}
	}
}

# Colony Bombarded by Horrors (on_planet_bombarded)
# 20 pops on pre ftl earth = 8
# From = Bombarder
planet_event = {
	id = shroud_rising_invasion.9
	title = "shroud_rising_invasion.9.name"
	desc = "shroud_rising_invasion.9.desc"
	picture = GFX_evt_shroud_city_ruins
	show_sound = event_ghost_town
	location = root
	is_triggered_only = yes
	trigger = {
		# has_global_flag = eot_incursions_start
		has_global_flag = eye_of_terror_open
		from = { is_country_type = shroud_horrors }
		OR = { planet_devastation > 99 num_pops < 2 }
	}
	immediate = {
		# if = { limit = { from = { is_country_type = shroud_horrors } }
		# every_playable_country = {
		# 	limit = { has_event_chain = "eye_of_terror_incursion_chain" }
		# 	add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_planets" amount = 1 }
		# }
		# }
		owner = {
			add_threat = { who = from amount = 1 }
			# save_event_target_as = devour_victim ?
			# set_country_flag = world_devoured ?
			set_country_flag = had_world_devoured
		}
		event_target:global_event_country = {
			change_variable = { which = "shroud_planets" value = 1 }
		}
		set_variable = { which = "shroud_entities_victims" value = trigger:num_pops }
		multiply_variable = { which = "shroud_entities_victims" value = 1000 }
		# if = {
		# 	limit = { num_pops >= 200 }
		# 		add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims" amount = 200000 }
		# 	}
		# }
		# else_if = {
		# 	limit = { num_pops >= 100 num_pops < 200 }
		# 		add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims" amount = 100000 }
		# }
		# else_if = {
		# 	limit = { num_pops >= 50 num_pops < 100 }
		# 		add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims" amount = 50000 }
		# 	}
		# }
		# else_if = {
		# 	limit = { num_pops >= 25 num_pops > 50 }
		# 		add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims" amount = 20000 }
		# }
		# else_if = {
		# 	limit = { num_pops < 25 }
		# 	add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims" amount = 10000 }
		# }

		every_playable_country = {
			limit = { has_event_chain = "eye_of_terror_incursion_chain" }
			add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_planets" amount = root.shroud_entities_victims }
		}

		destroy_colony = yes
		if = {
			limit = { is_artificial = no }
			reset_planet = yes
			change_pc = pc_shrouded
			add_modifier = { modifier = "devoured_world" days = -1 }
		}
		else_if = {
			limit = { has_ringworld_output_boost = yes }
			reset_planet = yes
			change_pc = pc_ringworld_habitable_damaged
			add_modifier = { modifier = "devoured_world" days = -1 }
		}
		else_if = {
			limit = { merg_is_habitat = yes }
			remove_planet = yes
		}
	}
	after = {
		hidden_effect = { clear_variable = shroud_entities_victims }
	}
	option = {
		name = "ancrel.11035.a"
		# custom_tooltip = shroud_rising_invasion.2.a.tooltip
	}
}

###############################################
###### Shroud Cult Empire events ####################
###############################################
##### Event to see if will be neutral to a shroud country (has civic_shroud_worship)
# Root = shroud_storm_horror or cultist_raid_fleet not playable
country_event = {
	id = shroud_rising_invasion.10
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		# exists = event_target:shroud_storm_horror
		is_ai = yes
		any_playable_country = { has_civic = civic_shroud_worship is_hostile = root }
	}
	immediate = {
		# It repeats every year
		# Chance for cult empires to become neutral
		random_playable_country = {
			limit = { is_ai = yes has_civic = civic_shroud_worship is_hostile = root }
			root = {
				random = { chance = 25
					set_faction_hostility = { set_hostile = no set_neutral = yes target = prev }
				}
			}
		}
		# Default empires
		random_playable_country = {
			limit = {
				is_ai = yes
				NOR = {
					has_civic = civic_shroud_worship
					is_hostile = root
					has_country_flag = chaos_empire
					has_country_flag = eye_of_terror_reopened_country
				}
			}
			root = {
				random = { chance = 50
					set_faction_hostility = { set_hostile = yes set_neutral = no target = prev }
				}
			}
		}
		# For terror re-opener
		if = {
			limit = { any_playable_country = { is_ai = yes has_country_flag = eye_of_terror_reopened_country is_hostile = root } }
			random_playable_country = {
				limit = { is_ai = yes has_country_flag = eye_of_terror_reopened_country is_hostile = root }
				# save_event_target_as = eye_of_terror_reopened_country
				root = {
					random = { chance = 50
						set_faction_hostility = { set_hostile = no set_neutral = yes target = prev }
					}
				}
			}
		}
	}
}

###############################################
###### Cultist Invasion Events ####################
###############################################
# ## Colony Bombarded by Cultists (on_planet_bombarded)
# From = Bombarder
planet_event = {
	id = shroud_rising_invasion.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = { planet_devastation >= 100 num_pops <= 2 }
		from = { is_country_type = shroud_cult }
		NOT = { has_modifier = recent_cult_invasion }
	}
	immediate = {
		from = {
			random_owned_fleet = {
				save_event_target_as = cult_occupier
				fleet_event = { id = shroud_rising_invasion.1305 days = 15 }
			}
			save_event_target_as = cult_occupier_country
			owner_species = { save_event_target_as = cultist_raid_fleet_species }
		}
		planet_event = { id = shroud_rising_invasion.13 }
		add_modifier = { modifier = "recent_cult_invasion" years = 2 }
		set_planet_flag = shroud_cult_invasion
		set_timed_planet_flag = { flag = recent_cult_influence years = 10 }
		random_galaxy_species = {
			limit = { is_crossbreeding_possible = yes NOT = { has_trait = trait_adeptus_custodes } }
			create_species = {
				name = "NAME_shroud_cultists"
				class = this # random_non_machine
				name_list = "CULTISTS"
				portrait = this # random
				traits = random
				effect = {
					random = { chance = 50 change_species_characteristics = { add_trait = trait_latent_psionic } }
					save_event_target_as = cultist_raid_fleet_species
				}
			}
		}
		while = { count = 4
			create_army = {
				name = "NAME_cultist_army"
				owner = from
				species = event_target:cultist_raid_fleet_species
				type = "shroud_cultist_army"
			}
			create_army = {
				name = "NAME_cultist_army"
				owner = from
				species = event_target:cultist_raid_fleet_species
				type = "cultist_slave_army"
			}
		}
		while = { count = 3
			create_army = {
				name = "NAME_cultist_army"
				owner = from
				species = event_target:cultist_raid_fleet_species
				type = "cultist_psionic_army"
			}
		}
		from = {
			create_leader = {
				class = commander
				species = event_target:cultist_raid_fleet_species
				name = random
				skill = 5
				leader_age_min = 25
				leader_age_max = 45
				traits = { trait = leader_trait_butcher trait = leader_trait_psionic }
			}
			random_owned_army = {
				limit = { NOT = { exists = leader } }
				assign_leader = last_created_leader
			}
		}
	}
}

# If Cultists win, place cult hub modifier (on_planet_attackers_win)
country_event = {
	id = shroud_rising_invasion.12
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = shroud_cult
		NOT = { fromfrom = { has_modifier = cult_stronghold } }
	}
	immediate = {
		fromfrom = {
			add_modifier = { modifier = "cult_stronghold" }
			set_planet_flag = shroud_cult_occupation			# For planetary decision popup
			save_event_target_as = cultist_nest_location
			create_fleet = {
				name = "cultist_nest"
				effect = {
					set_owner = root
					create_ship = { name = "cultist_nest" design = "NAME_Pirate_Nest" graphical_culture = "pirate_01" }
					set_location = prev
					set_fleet_stance = aggressive
				}
			}
			create_fleet = {
				effect = {
					set_fleet_flag = cultist_fleet
					set_owner = root
					set_location = prev
					set_fleet_stance = aggressive
					set_aggro_range = 150
					set_aggro_range_measure_from = self
					set_fleet_bombardment_stance = indiscriminate
					 # destroyer?
					create_ship = { name = random design = "NAME_Ravager" graphical_culture = "avian_01" }
				}
			}
			planet_event = { id = shroud_rising_invasion.1304 days = 60 random = 30 }
		}
	}
}

# Inform owner, if there is one that his planet is now fucked
planet_event = {
	id = shroud_rising_invasion.13
	title = "shroud_rising_invasion.13.name"
	desc = "shroud_rising_invasion.13.desc"
	picture = GFX_evt_ground_combat
	show_sound = event_ground_battle
	is_triggered_only = yes
	location = root
	pre_triggers = { has_owner = yes }
	trigger = { exists = owner }
	immediate = {
		owner = { save_event_target_as = cult_raid_victim }
		event_target:cult_raid_victim = { set_country_flag = had_world_invaded_by_cult }
	}
	option = {
		name = "astral_rift.50.a"
		custom_tooltip = shroud_rising_invasion.13.a.tooltip
		hidden_effect = {
			random_owned_pop = { kill_pop = yes }
			owner = {
				random_list = {
					33 = { country_event = { id = shroud_rising_invasion.1301 } }
					33 = { country_event = { id = shroud_rising_invasion.1302 } }
					33 = { country_event = { id = shroud_rising_invasion.1303 } }
				}
			}
		}
	}
}

# Cultists Make themselves known v1
country_event = {
	id = shroud_rising_invasion.1301
	title = TRANSMISSION
	desc = "shroud_rising_invasion.1301.desc"
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:cult_occupier_country
		planet_background = root
		graphical_culture = root
		room = personality_slaving_despots_room
		city_level = root
	}
	option = { name = "shroud_rising_invasion.1303.a" response_text = shroud_rising_invasion.1301.a.response is_dialog_only = yes }
	option = { name = "06_FALLEN_EMPIRE_DISMISSIVE_GREETING" response_text = shroud_rising_invasion.1301.b.response is_dialog_only = yes }
	option = { name = "crisis.76.c" response_text = "utopia.3000.9.desc" }
}

country_event = {
	id = shroud_rising_invasion.1302
	title = TRANSMISSION
	desc = "shroud_rising_invasion.1302.desc"
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:cult_occupier_country
		planet_background = root
		graphical_culture = root
		room = personality_slaving_despots_room
		city_level = root
	}
	option = { name = "shroud_rising_invasion.1303.a" response_text = shroud_rising_invasion.1302.a.response is_dialog_only = yes }
	option = { name = "crisis.8060.c" response_text = shroud_rising_invasion.1302.b.response is_dialog_only = yes }
	option = { name = "crisis.76.c" response_text = "paragon.555.a" }
}

country_event = {
	id = shroud_rising_invasion.1303
	title = TRANSMISSION
	desc = "shroud_rising_invasion.1303.desc"
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:cult_occupier_country
		planet_background = root
		graphical_culture = root
		room = personality_slaving_despots_room
		city_level = root
	}
	option = { name = shroud_rising_invasion.1303.a response_text = shroud_rising_invasion.1303.a.response is_dialog_only = yes }
	option = { name = "06_FALLEN_EMPIRE_DISMISSIVE_GREETING" response_text = shroud_rising_invasion.1303.b.response is_dialog_only = yes }
	option = { name = "crisis.76.c" response_text = shroud_rising_invasion.1303.c.response }
}

# Cleanup if cultist are stuck or have finished bombarding a planet
# Re-enabled on v.3.11
planet_event = {
	id = shroud_rising_invasion.1304
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = from
		from = {
			is_country_type = shroud_cult
			any_owned_fleet = { is_fleet_idle = yes is_mobile = yes }
		}
	}
	immediate = {
		closest_system = {
			limit = {
				any_system_colony = {
					NOR = {
						has_planet_flag = cultist_raid_target
						has_modifier = recent_cult_invasion
						has_modifier = cult_stronghold
						num_sapient_pops < 1
					}
				}
			}
			random_system_colony = {
				limit = {
					NOR = {
						has_planet_flag = cultist_raid_target
						has_modifier = recent_cult_invasion
						has_modifier = cult_stronghold
						num_sapient_pops < 1
					}
				}
				set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
				save_event_target_as = new_cultist_raid_target
				from = {
					random_owned_fleet = {
						limit = { is_fleet_idle = yes is_mobile = yes }
						auto_move_to_planet = { target = event_target:new_cultist_raid_target clear_auto_move_on_arrival = yes }
						fleet_event = { id = shroud_rising_invasion.1305 scopes = { from = event_target:new_cultist_raid_target } days = 30 }
					}
				}
			}
		}
	}
}

# From = event_target:new_cultist_raid_target
fleet_event = {
	id = shroud_rising_invasion.1305
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = owner
		owner = { is_country_type = shroud_cult }
		is_fleet_idle = yes
	}
	immediate = {
		if = {
			limit = { NOT = { exists = event_target:new_cultist_raid_target } }
			if = {
				limit = { exists = from }
				from = { save_event_target_as = new_cultist_raid_target }
			}
			else = {
				closest_system = {
					limit = {
						any_system_colony = {
							NOR = {
								has_planet_flag = cultist_raid_target
								has_modifier = recent_cult_invasion
								has_modifier = cult_stronghold
								num_sapient_pops < 1
							}
						}
					}
					random_system_colony = {
						limit = {
							NOR = {
								has_planet_flag = cultist_raid_target
								has_modifier = recent_cult_invasion
								has_modifier = cult_stronghold
								num_sapient_pops < 1
							}
						}
						set_timed_planet_flag = { flag = cultist_raid_target months = 20 }
						save_event_target_as = new_cultist_raid_target
					}
				}
			}
		}
		queue_actions = {
			find_closest_system = {
				trigger = {
					id = shroud_rising_invasion.1305.t1
					any_system_planet = { is_same_value = event_target:new_cultist_raid_target }
				}
				found_system = {
					move_to = this
					find_closest_planet = {
						trigger = { id = shroud_rising_invasion.1305.t2 is_same_value = event_target:new_cultist_raid_target }
						found_planet = { move_to = this orbit_planet = this }
					}
				}
			}
		}
	}
}

###############################################
###### Incursion Announce Events ####################
###############################################
# Small Cult Fleet
country_event = {
	id = shroud_rising_invasion.2011
	hide_window = no
	title = "shroud_rising_invasion.2011.name"
	desc = "shroud_rising_invasion.2011.desc"
	picture = GFX_evt_command_center
	show_sound = event_yellow_alert
	is_triggered_only = yes
	location = from	# event_target:eye_of_terror_system
	immediate = { }
	option = { name = "distar.7.b" }
}

# Small Cultist Crusade
country_event = {
	id = shroud_rising_invasion.2012
	hide_window = no
	title = "shroud_rising_invasion.2012.name"
	desc = "shroud_rising_invasion.2012.desc"
	picture = GFX_evt_command_center
	show_sound = event_yellow_alert
	is_triggered_only = yes
	location = from	# event_target:eye_of_terror_system
	immediate = { }
	option = { name = "distar.7.b" }
}

# Shroud Lesser Horror Entity
country_event = {
	id = shroud_rising_invasion.2021
	hide_window = no
	title = "shroud_rising_invasion.2021.name"
	desc = "shroud_rising_invasion.2021.desc"
	picture = GFX_evt_command_center
	show_sound = event_yellow_alert
	is_triggered_only = yes
	location = from	# event_target:eye_of_terror_system
	immediate = { }
	option = { name = "distar.7.b" }
}

# Large Lesser Horror Entity Group
country_event = {
	id = shroud_rising_invasion.2022
	hide_window = no
	title = "shroud_rising_invasion.2022.name"
	desc = "shroud_rising_invasion.2022.desc"
	picture = GFX_evt_command_center
	show_sound = event_yellow_alert
	is_triggered_only = yes
	location = from	# event_target:eye_of_terror_system
	immediate = { }
	option = { name = "distar.7.b" }
}

# Announce avatar greater rift
country_event = {
	id = shroud_rising_invasion.2031
	hide_window = no
	title = "shroud_rising_invasion.2032.name"
	desc = "shroud_rising_invasion.2032.desc"
	picture = GFX_evt_command_center
	show_sound = event_yellow_alert
	is_triggered_only = yes
	location = from	# event_target:eye_of_terror_system
	immediate = { }
	option = { name = "distar.7.b" }
}

# Announce avatar EoT
# From = System
country_event = {
	id = shroud_rising_invasion.2032
	hide_window = no
	title = "shroud_rising_invasion.2032.name"
	desc = "shroud_rising_invasion.2032.desc"
	picture = GFX_evt_command_center
	show_sound = event_yellow_alert
	is_triggered_only = yes
	location = from	# event_target:eye_of_terror_system
	immediate = { }
	option = { name = "distar.7.b" }
}

# Announce cosmic horror
country_event = {
	id = shroud_rising_invasion.2033
	hide_window = no
	title = "shroud_rising_invasion.2033.name"
	desc = "shroud_rising_invasion.2033.desc"
	picture = GFX_evt_eye_of_terror_god_2	# GFX_evt_space_monster_shroud
	show_sound = event_yellow_alert
	is_triggered_only = yes
	location = from	# event_target:eye_of_terror_system
	immediate = { }
	option = { name = "distar.7.b" }
}

###############################################
###### Death Counter Events (Hidden) ####################
###############################################
# Shroud Entities Death Count (HIDDEN on_ship_destroyed_victim)
country_event = {
	id = shroud_rising_invasion.100
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eot_incursions_start
		OR = { is_country_type = shroud_entities is_country_type = shroud_horrors is_country_type = shroud_cult }
	}
	immediate = {
		if = {
			limit = {
				exists = from
				from = { has_event_chain = "eye_of_terror_incursion_chain" }
			}
			from = {
				add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_kills_us" amount = 1 }
			}
		}
	}
}

# Shroud Entities Victims (HIDDEN on_ship_destroyed_perp)
# This = owner of ship 1 (combatant)
# From = owner of ship 2 (destroyed)
# fromfrom = ship 1
# fromfromfrom = ship 2
country_event = {
	id = shroud_rising_invasion.101
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eot_incursions_start
		OR = { is_country_type = shroud_entities is_country_type = shroud_horrors is_country_type = shroud_cult }
	}
	immediate = {
		if = {
			limit = {
				exists = from
				from = { has_event_chain = "eye_of_terror_incursion_chain" }
			}
			from = {
				add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims_us" amount = 1 }
			}
		}
		every_playable_country = {
			limit = { has_event_chain = "eye_of_terror_incursion_chain" }
			add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims" amount = 1 }
		}
	}
}

# Shroud Entities Armies killed (HIDDEN on_army_killed_in_combat)
country_event = {
	id = shroud_rising_invasion.102
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eot_incursions_start
		from = {
			OR = {
				army_type = shroud_cultist_army
				army_type = shroud_horror_army_1
				army_type = shroud_horror_army_2
				army_type = shroud_greater_horror_army
				army_type = cultist_slave_army
				army_type = cultist_psionic_army
			}
		}
	}
	immediate = {
		if = {
			limit = { exists = fromfrom fromfrom = { has_event_chain = "eye_of_terror_incursion_chain" } }
			fromfrom = {
				add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_kills_us" amount = 1 }
			}
		}
	}
}

# Shroud Entities Army Victims (HIDDEN on_army_killed_in_combat)
# This = owner
# From = army
# fromfrom = opponent
# fromfromfrom = planet
country_event = {
	id = shroud_rising_invasion.103
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eot_incursions_start
		fromfrom = {
			OR = { is_country_type = shroud_entities is_country_type = shroud_horrors is_country_type = shroud_cult }
		}
	}
	immediate = {
		if = {
			limit = { has_event_chain = "eye_of_terror_incursion_chain" }
			add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_army_victims" amount = 1 }
		}
		every_playable_country = {
			limit = { has_event_chain = "eye_of_terror_incursion_chain" }
			add_event_chain_counter = { event_chain = "eye_of_terror_incursion_chain" counter = "shroud_entities_victims" amount = 1 }
		}
	}
}

###############################################
###### Ancient God Events ####################
###############################################
# Spawn Ancient God
system_event = {
	id = shroud_rising_invasion.105
	hide_window = yes
	# fire_only_once = yes
	is_triggered_only = yes
	trigger = {
		# mid_game_years_passed > 50
		has_global_flag = eye_of_terror_open
		NOR = { has_global_flag = eye_of_terror_sealed has_global_flag = ancient_god_active has_global_flag = ancient_god_defeated }
	}
	immediate = {
		set_global_flag = ancient_god_active
		every_country = {
			limit = { is_default_or_fallen = yes }
			add_modifier = { modifier = god_voices }
		}
		every_playable_country = {
			limit = { is_ai = no }
			country_event = { id = shroud_rising_invasion.106 }			# Announce to galaxy
		}
		if = {
			limit = { NOT = { exists = event_target:shroud_god_country } }
			create_country = {
				name = "NAME_ancient_god_name"
				type = shroud_horrors
				name_list = "SHROUD_HORRORS"
				flag = {
					icon = { category = "special" file = "the_shroud.dds" }
					background = { category = "backgrounds" file = "00_solid.dds" }
					colors = { "dark_purple" "black" "null" "null" }
				}
				effect = {
					apply_shroud_rising_difficulty = yes
					save_global_event_target_as = shroud_god_country
					country_event = { id = shroud_rising_invasion.1055 days = 30 } # Add threat
				}
			}
		}
		create_fleet = {
			# name = random
			settings = { spawn_debris = no is_boss = yes }
			effect = {
				set_owner = event_target:shroud_god_country
				create_ship = { name = "NAME_ancient_god_name" design = "NAME_ancient_god" }
				set_location = root
				set_fleet_stance = aggressive
				set_fleet_bombardment_stance = devour
				set_aggro_range_measure_from = self
				set_aggro_range = 500
				set_fleet_flag = ancient_god
			}
		}
	}
	after = {
		last_created_fleet = {
			set_fleet_bombardment_stance = armageddon
		}
	}
}

# Announce Ancient God Spawn
country_event = {
	id = shroud_rising_invasion.1055
	hide_window = yes
	is_triggered_only = yes
	trigger = { }
	immediate = {
		add_threat = { who = root amount = 500 }
		from = { add_threat = { who = prev amount = 50 } }
		every_country = {
			limit = { is_default_or_fallen = yes }
			add_opinion_modifier = { who = root modifier = opinion_destroying_galaxy }
		}
	}
}
# Announce Ancient God Spawn
country_event = {
	id = shroud_rising_invasion.106
	hide_window = no
	title = "shroud_rising_invasion.106.name"
	desc = "shroud_rising_invasion.106.desc"
	picture = GFX_evt_eye_of_terror_god
	show_sound = event_red_alert
	is_triggered_only = yes
	location = event_target:eye_of_terror_system
	trigger = { }
	immediate = { }
	option = { name = shroud_rising_invasion.106.a custom_tooltip = shroud_rising_invasion.106.a.tooltip }
}

# Ancient God Defeated (HIDDEN on_ship_destroyed_victim)
country_event = {
	id = shroud_rising_invasion.107
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = shroud_horrors
		fromfrom.fleet = { num_ships = 0 has_fleet_flag = ancient_god }
	}
	immediate = {
		set_timed_global_flag = { flag = ancient_god_defeated years = 25 }
		remove_global_flag = ancient_god_active
		fromfrom = {
			fleet = { save_event_target_as = ancient_god }
			solar_system = { save_event_target_as = ancient_god_death_system }
		}
		from = {
			save_event_target_as = ancient_god_destroyer
			set_timed_country_flag = { flag = ancient_god_destroyer days = 200 } # For special reward
			country_event = { id = shroud_rising_invasion.108 }
		}
		every_country = {
			limit = { OR = { is_fallen_empire = yes has_civic = civic_shroud_worship } }
			country_event = { id = shroud_rising_invasion.108 }
		}
		every_playable_country = {
			limit = { NOR = { is_same_empire = from has_civic = civic_shroud_worship } }
			add_opinion_modifier = { who = from modifier = opinion_defeated_ancient_god }
			country_event = { id = shroud_rising_invasion.108 }
		}
	}
}

# God defeated killer message
country_event = {
	id = shroud_rising_invasion.108
	title = "shroud_rising_invasion.108.name"
	desc = "shroud_rising_invasion.108.desc"
	picture = GFX_evt_crisis_defeated
	show_sound = event_celebration
	location = event_target:ancient_god_death_system
	is_triggered_only = yes
	immediate = {
		if = {
			limit = { has_modifier = god_voices }
			remove_modifier = god_voices
		}
	}
	option = {
		name = shroud_rising_invasion.108.a
		if = {
			limit = { NOT = { has_civic = civic_shroud_worship } }
			add_modifier = { modifier = ancient_god_defeated years = 10 }
		}
	}
	option = {
		name = shroud_rising_invasion.108.b
		exclusive_trigger = { has_civic = civic_shroud_worship }
	}
	option = {
		name = shroud_rising_invasion.108.c
		exclusive_trigger = {
			has_country_flag = ancient_god_destroyer
			NOT = { has_civic = civic_shroud_worship }
		}
		add_modifier = { modifier = ancient_god_destroyer years = 25 }
		add_monthly_resource_mult = {
			resource = unity
			value = 120
			min = 240
			max = 9999
		}
		add_resource = { influence = 300 }
		add_relic = r_god_heart
	}
}

# Spawns an ancient god after 15 planets devoured (if not already currently spawned)
event = {
	id = shroud_rising_invasion.109
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eye_of_terror_open
		exists = event_target:eye_of_terror_system
		NOR = { has_global_flag = eye_of_terror_sealed has_global_flag = ancient_god_defeated has_global_flag = ancient_god_active }
		event_target:global_event_country = {
			check_variable = { which = shroud_planets value > 14 }
		}
	}
	immediate = {
		event_target:eye_of_terror_system = {
			system_event = { id = shroud_rising_invasion.105 days = 5 }
		}
	}
}
